<!DOCTYPE html>

<head>
    <title>Brain Trading</title>
    <script src="https://unpkg.com/brain.js@1.6.0/browser.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>
    <script>

        let data = [[1558120500000,"7083.80000000","7109.39000000","7045.10000000","7074.72000000","502.23389600",1558121399999,"3553863.49364854",5549,"313.70253400","2220150.85138440","0"],[1558121400000,"7074.56000000","7111.00000000","7062.65000000","7109.99000000","386.70745900",1558122299999,"2740640.78856487",4812,"233.14528000","1652479.60322672","0"],[1558122300000,"7109.66000000","7144.99000000","7074.16000000","7136.72000000","624.92853400",1558123199999,"4443768.12693101",6303,"386.56841300","2749606.74980440","0"],[1558123200000,"7135.73000000","7138.87000000","7080.00000000","7111.93000000","573.94983200",1558124099999,"4081158.12261456",5974,"275.84204500","1961814.27180262","0"],[1558124100000,"7111.80000000","7124.66000000","7079.02000000","7101.36000000","439.47876700",1558124999999,"3123029.37634794",5082,"214.03504900","1521131.92899801","0"],[1558125000000,"7101.17000000","7119.28000000","7070.00000000","7115.39000000","342.58465400",1558125899999,"2430365.94538514",4089,"182.44073900","1294578.59381775","0"],[1558125900000,"7115.33000000","7140.00000000","7097.08000000","7124.60000000","358.33754000",1558126799999,"2550663.24612252",4738,"212.29238700","1511181.88351348","0"],[1558126800000,"7124.62000000","7244.01000000","7122.00000000","7243.86000000","1169.71598900",1558127699999,"8419701.70776648",10011,"737.13637500","5305813.97923481","0"],[1558127700000,"7241.50000000","7249.59000000","7165.00000000","7208.20000000","792.06952000",1558128599999,"5721560.27572794",6836,"270.08763400","1949690.63910520","0"],[1558128600000,"7209.72000000","7250.00000000","7200.71000000","7232.56000000","695.27621200",1558129499999,"5026278.69294325",5726,"441.63636400","3191843.19273533","0"],[1558129500000,"7230.89000000","7280.00000000","7230.89000000","7264.69000000","524.50137700",1558130399999,"3807686.30798745",5290,"279.16655000","2026650.31597027","0"],[1558130400000,"7264.64000000","7308.25000000","7253.67000000","7266.10000000","793.54581200",1558131299999,"5786749.53104849",7215,"477.71886800","3484297.24330812","0"],[1558131300000,"7263.34000000","7294.64000000","7191.00000000","7215.70000000","1030.95448200",1558132199999,"7472479.05570772",8201,"490.15324300","3552603.20447571","0"],[1558132200000,"7215.36000000","7266.12000000","7191.00000000","7256.30000000","454.91110500",1558133099999,"3289248.90776813",4133,"251.93753200","1822046.59792637","0"],[1558133100000,"7257.53000000","7266.38000000","7227.62000000","7240.69000000","291.12437700",1558133999999,"2110614.88337568",3183,"129.68031800","939985.08900114","0"],[1558134000000,"7240.12000000","7291.66000000","7231.17000000","7289.13000000","491.90659200",1558134899999,"3576595.56413500",4379,"227.00261600","1648978.19097242","0"],[1558134900000,"7289.14000000","7298.99000000","7262.01000000","7281.02000000","327.75369700",1558135799999,"2386570.01581951",3398,"145.80420800","1061377.36098625","0"],[1558135800000,"7280.18000000","7375.00000000","7280.18000000","7316.96000000","1156.35250900",1558136699999,"8482066.09452467",8514,"644.96066400","4731250.10324339","0"],[1558136700000,"7316.73000000","7371.42000000","7311.01000000","7355.26000000","541.60758800",1558137599999,"3979249.94982578",5081,"303.94932300","2233191.68280344","0"],[1558137600000,"7355.28000000","7434.61000000","7354.50000000","7392.90000000","1187.73835000",1558138499999,"8789952.14598284",10221,"637.06140500","4714670.38364341","0"],[1558138500000,"7393.41000000","7398.80000000","7290.00000000","7342.73000000","1197.27297000",1558139399999,"8791590.91284905",10073,"600.01947700","4405899.24829800","0"],[1558139400000,"7343.78000000","7350.00000000","7290.00000000","7304.94000000","557.30429500",1558140299999,"4081162.30732309",5173,"272.04291100","1992185.82364076","0"],[1558140300000,"7305.84000000","7314.30000000","7255.05000000","7284.62000000","504.93299500",1558141199999,"3678729.12768749",4883,"254.17794800","1851851.21134187","0"],[1558141200000,"7286.04000000","7331.88000000","7282.28000000","7322.72000000","553.65032800",1558142099999,"4046810.23457507",4710,"260.69732700","1905355.76607515","0"],[1558142100000,"7321.70000000","7339.57000000","7273.03000000","7283.15000000","427.77768600",1558142999999,"3126463.73299143",4297,"203.76742500","1489324.81419914","0"],[1558143000000,"7283.20000000","7296.62000000","7227.00000000","7247.25000000","460.89065500",1558143899999,"3348049.31207156",5118,"232.74431700","1691257.69623658","0"],[1558143900000,"7248.95000000","7282.85000000","7227.12000000","7259.31000000","467.95235900",1558144799999,"3396995.77785275",4630,"275.44931700","1999602.09933190","0"],[1558144800000,"7259.27000000","7314.12000000","7256.53000000","7292.55000000","359.04479700",1558145699999,"2617637.11102345",4203,"201.83583200","1471450.45507640","0"]]
       
        const high = []
        const low = []

        function prune(v) {
            return {
                open: parseFloat(v[1]),
                high: parseFloat(v[2]),
                low: parseFloat(v[3]),
                close: parseFloat(v[4])
            }
        }

        function findHighLow(v) {
            high.push(v.high)
            low.push(v.low)
        }

        let pruned = data.map(prune)
        pruned.map(findHighLow)

        var maxInitialData = d3.max(high);
        var minInitialData = d3.min(low);

        var scaleDown = d3.scaleLinear()
            .domain([minInitialData, maxInitialData])
            .range([0, 1]);

        var scaleUp = d3.scaleLinear()
            .domain([0, 1])
            .range([minInitialData, maxInitialData]);

        function scaleDataUp(x) {
            return {
                open: parseFloat(scaleUp(x.open)),
                high: parseFloat(scaleUp(x.high)),
                low: parseFloat(scaleUp(x.low)),
                close: parseFloat(scaleUp(x.close))

            }
        }

        function ScaleDataDown(x) {
            return {
                open: parseFloat(scaleDown(x.open)),
                high: parseFloat(scaleDown(x.high)),
                low: parseFloat(scaleDown(x.low)),
                close: parseFloat(scaleDown(x.close))
            }
        }

        function chunks(cut) {
            let array = []
            for (x in cut) {
                let number = x
                if (x % 5 == true) {
                    var a = parseInt(number) - 1
                    var b = parseInt(number) + 4
                    array.push(cut.slice(a, b))
                }
            }
            return array
        }

        let results = chunks(pruned)

        let trainingData = results.map(el => {
            return el.map(ScaleDataDown)
        })

        const net = new brain.recurrent.LSTMTimeStep({
            inputSize: 4,
            hiddenLayers: [8, 8],
            outputSize: 4
        });

        net.train(trainingData, {
            learningRate: 0.005,
            errorThresh: 0.01,
            //log: (stats) => console.log(stats)
        });

        let arrayPos = 2

        let trainingResults = (net.forecast([
            trainingData[arrayPos][0],
            trainingData[arrayPos][1],
            trainingData[arrayPos][2],
            trainingData[arrayPos][3],
            trainingData[arrayPos][4],
        ], 5).map(scaleDataUp))


        console.log("**next 5 prediction**")
        console.log(trainingResults)
        console.log("**next 5 prediction**")

        console.log("**real given data**")
        console.log(trainingData[arrayPos].map(scaleDataUp))
        console.log("**real price movemnet**")
        console.log(trainingData[arrayPos + 1].map(scaleDataUp))
        console.log("**real price movemnet**")

    </script>
</body>

</html>